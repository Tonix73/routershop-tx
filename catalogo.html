<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RouterShop TX - Tienda de Redes</title>
    <link rel="icon" type="image/png"
        href="https://qalbtsegnuwbnjnndvag.supabase.co/storage/v1/object/public/fotos-productos/logo.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;800&display=swap" rel="stylesheet">

    <link rel="stylesheet" href="css/estilos.css">

</head>

<body>
    
    <div id="app-navbar"></div>

    <div class="controles">
        <div class="buscador-header">
            <input type="text" id="buscador" placeholder="üîç Buscar..."
                onkeyup="if(window.buscarProducto) window.buscarProducto()">
        </div>
        <div id="contenedor-categorias" class="botones-categorias">
            <button class="btn-cat activo">Cargando...</button>
        </div>
    </div>

    <div id="lista-productos" class="grid">
        <div style="grid-column: span 3; text-align: center; padding: 40px;">
            <p style="color:#666; font-size:1.2em;">üì° Cargando inventario...</p>
        </div>
    </div>


    <div id="app-footer"></div>

    <div id="notificacion-toast" class="notificacion-container">
        <span id="notif-icono" class="material-icons">info</span><span id="notif-mensaje">Mensaje</span>
    </div>

    <div id="modal-carrito" class="modal-fondo">
        <div class="modal-contenido">
            <span class="cerrar-modal" onclick="cerrarModal('modal-carrito')">√ó</span>
            <h2
                style="margin-top:0; color:#333; display:flex; align-items:center; gap:10px; justify-content: center !important;">
                <span class="material-icons" style="color:#0056b3;">shopping_cart</span> Tu Carrito
            </h2>

            <div style="max-height: 50vh; overflow-y: auto; overflow-x: hidden;">
                <table class="tabla-carrito">
                    <tbody id="cuerpo-tabla-carrito"></tbody>
                </table>
            </div>

            <div class="total-pagar" id="total-carrito">Total: $0.00</div>
            <button id="btn-pagar-dinamico" class="btn-ir-pagar" onclick="procederAlPago()">Proceder al Pago ‚ûù</button>
        </div>
    </div>

    <div id="modal-login" class="modal-fondo">
        <div class="modal-contenido">
            <span class="cerrar-modal" onclick="cerrarModal('modal-login')">√ó</span>
            <h2 id="titulo-login" style="text-align:center; margin-top:0;">Iniciar Sesi√≥n</h2>
            <div class="form-grupo"><label>Correo</label><input type="email" id="email-input" class="input-login">
            </div>
            <div class="form-grupo"><label>Contrase√±a</label><input type="password" id="password-input"
                    class="input-login">
                <div style="text-align: right; margin-top: 5px;"><a href="#" onclick="recuperarContrasena()"
                        style="color: #666; font-size: 0.85em; text-decoration: none;">¬øOlvidaste tu contrase√±a?</a>
                </div>
            </div>
            <button class="btn-full" onclick="manejarAuth()">Entrar</button>
            <p id="error-login" style="color: red; text-align: center; margin-top: 15px; font-size:0.9em;"></p>
            <span class="link-toggle" onclick="toggleModoLogin()">¬øNo tienes cuenta? Reg√≠strate aqu√≠</span>
        </div>
    </div>

    <div id="modal-reset-password" class="modal-fondo">
        <div class="modal-contenido" style="border-top-color: #ffc107;">
            <h2 style="text-align:center; margin-top:0;">üîí Nueva Contrase√±a</h2>
            <div class="form-grupo"><input type="password" id="new-password-input" class="input-login"
                    placeholder="M√≠nimo 6 caracteres"></div>
            <button class="btn-full" onclick="guardarNuevaContrasena()"
                style="background-color:#ffc107; color:#333;">Actualizar</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/loader.js"></script>
    <script src="js/app.js"></script>
    <script>
        let categoriaActual = null;

        // Al cargar la p√°gina
        window.onload = function () {
            // Verificar si hay hash para abrir modales (redirecci√≥n desde perfil)
            if (window.location.hash === '#abrir-carrito') { setTimeout(() => abrirCarrito(), 500); history.replaceState(null, null, 'index.html'); }
            if (window.location.hash === '#abrir-login') { setTimeout(() => abrirLogin(), 500); history.replaceState(null, null, 'index.html'); }

            // Cargar datos
            cargarCategorias();
            cargarProductos();
        };

        // Cargar Categor√≠as
        async function cargarCategorias() {
            const { data } = await clienteSupabase.from('categorias').select('*').order('nombre');
            if (data) {
                const contenedor = document.getElementById('contenedor-categorias');
                contenedor.innerHTML = '<button class="btn-cat activo" onclick="filtrarPorCategoria(null, this)">Todos</button>';
                data.forEach(cat => {
                    contenedor.innerHTML += `<button class="btn-cat" onclick="filtrarPorCategoria(${cat.id}, this)">${cat.nombre}</button>`;
                });
            }
        }

        // Cargar Productos
        async function cargarProductos(busqueda = '') {
            let consulta = clienteSupabase.from('productos').select('*');

            if (categoriaActual !== null) consulta = consulta.eq('categoria_id', categoriaActual);
            if (busqueda.length > 0) consulta = consulta.ilike('nombre', `%${busqueda}%`);

            const { data, error } = await consulta;

            if (error) {
                console.error(error);
                document.getElementById('lista-productos').innerHTML = '<p style="text-align:center; width:100%;">Error cargando productos.</p>';
                return;
            }

            mostrarEnPantalla(data);
        }

        // Renderizar (Dibujar) productos
        function mostrarEnPantalla(productos) {
            const contenedor = document.getElementById('lista-productos');
            contenedor.innerHTML = '';

            if (!productos || productos.length === 0) {
                contenedor.innerHTML = '<div style="grid-column:span 3; text-align:center; padding:20px; color:#777;">No se encontraron productos que coincidan.</div>';
                return;
            }

            productos.forEach(prod => {
                const img = prod.imagen_url || 'https://via.placeholder.com/150';
                contenedor.innerHTML += `
                    <div class="card">
                        <a href="producto.html?id=${prod.id}" style="text-decoration:none; color:inherit; display:block;">
                            <img src="${img}" alt="${prod.nombre}" onerror="this.src='https://via.placeholder.com/150'">
                            <div>
                                <h3>${prod.nombre}</h3>
                                <p class="precio">$${prod.precio.toFixed(2)}</p>
                            </div>
                        </a>
                        <button class="add-cart" onclick="agregarAlCarrito(${prod.id}, '${prod.nombre}', ${prod.precio}, '${img}')">
                            <span class="material-icons">add_shopping_cart</span> Agregar
                        </button>
                    </div>`;
            });
        }

        // Filtros
        function filtrarPorCategoria(id, btn) {
            categoriaActual = id;
            document.querySelectorAll('.btn-cat').forEach(b => b.classList.remove('activo'));
            btn.classList.add('activo');

            // Validamos que exista el buscador antes de pedir su valor
            const inputBusqueda = document.getElementById('buscador');
            const valorBusqueda = inputBusqueda ? inputBusqueda.value : '';
            cargarProductos(valorBusqueda);
        }

        // Esta funci√≥n se llamar√° desde el header cuando pegues el c√≥digo all√°
        function buscarProducto() {
            const inputBusqueda = document.getElementById('buscador');
            const valorBusqueda = inputBusqueda ? inputBusqueda.value : '';
            cargarProductos(valorBusqueda);
        }
    </script>
</body>

</html>