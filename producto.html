<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Producto - RouterShop TX</title>
    <link rel="icon" type="image/png"
        href="https://qalbtsegnuwbnjnndvag.supabase.co/storage/v1/object/public/fotos-productos/logo.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="css/producto.css">


</head>

<body>
    <div id="loader-wrapper" class="loader-container">
        <div class="loader-brand">
            <img src="https://qalbtsegnuwbnjnndvag.supabase.co/storage/v1/object/public/fotos-productos/logo.png"
                style="height: 60px;">

            <div style="text-align: left;">
                <div style="color: #003366; font-weight: 800; font-size: 24px; font-family: 'Poppins', sans-serif;">
                    RouterShop</div>
                <div
                    style="color: #ffc107; font-weight: 800; font-size: 24px; font-family: 'Poppins', sans-serif; line-height: 0.8;">
                    TX</div>
            </div>
        </div>
        <div class="spinner"></div>
    </div>
    <div id="app-navbar"></div>
    <div id="notificacion-toast" class="notificacion-container"><span id="notif-icono"
            class="material-icons">info</span><span id="notif-mensaje">Mensaje</span></div>

    <div id="detalle-producto" class="contenedor-detalle">
        <p>Cargando...</p>
    </div>

    <div class="seccion-extra" id="seccion-ficha-tecnica" style="display: none;">
        <h3 style="border-bottom: 2px solid #f4f4f4; padding-bottom: 15px; margin-bottom: 20px;">
            <span class="material-icons" style="vertical-align: sub; color: #0056b3;">settings</span>
            Especificaciones TÃ©cnicas
        </h3>

        <div class="tabla-specs-container">
            <table class="tabla-specs">
                <tbody id="cuerpo-tabla-specs">
                </tbody>
            </table>
        </div>
    </div>

    <div class="seccion-extra" id="seccion-resenas" style="display:none;">
        <div class="header-resenas">
            <h3>Opiniones de Clientes</h3>
            <div class="box-rating-score">
                <span id="txt-promedio" class="rating-number">0.0</span>
                <span class="rating-stars-total">
                    <span class="material-icons">star</span>
                </span>
                <span id="txt-total-votos" class="rating-count">(0)</span>
            </div>
        </div>

        <div id="lista-resenas" style="max-height:400px; overflow-y:auto;"></div>

        <div id="box-form-resena" class="form-resena">
            <h4 style="margin-top:0;">Â¡Danos tu opiniÃ³n!</h4>
            <select id="sel-estrellas"
                style="padding:10px; width:100%; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;">
                <option value="5">â˜…â˜…â˜…â˜…â˜… Excelente</option>
                <option value="4">â˜…â˜…â˜…â˜…â˜† Bueno</option>
                <option value="3">â˜…â˜…â˜…â˜†â˜† Regular</option>
                <option value="2">â˜…â˜…â˜†â˜†â˜† Malo</option>
                <option value="1">â˜…â˜†â˜†â˜†â˜† PÃ©simo</option>
            </select>
            <textarea id="txt-comentario" rows="3"
                style="width:100%; box-sizing:border-box; padding:10px; border:1px solid #ddd; border-radius:5px;"
                placeholder="CuÃ©ntanos tu experiencia..."></textarea>
            <button onclick="enviarResena()" class="btn-full" style="width:auto;">Publicar OpiniÃ³n</button>
        </div>
        <div id="msg-login-resena" class="msg-login-resena">
            Para dejar una opiniÃ³n, necesitas <span class="link-login" onclick="abrirLogin()">iniciar sesiÃ³n</span>.
        </div>
    </div>

    <div class="seccion-extra" id="seccion-recomendados" style="display:none;">
        <h3>Productos Relacionados</h3>
        <div id="grid-recomendados" class="grid-recomendados"></div>
    </div>

    <div id="app-footer"></div>

    <div id="modal-lightbox" class="lightbox-modal">
        <span class="close-lightbox" onclick="cerrarLightbox()">&times;</span>
        <img class="lightbox-content" id="img-lightbox-full">
    </div>

    <script src="js/loader.js"></script>
    <script src="js/app.js"></script>
    <script>
        // Solo declaramos la variable nueva que NO estÃ¡ en app.js
        let productoActual = null;

        // NO declaramos 'carrito' ni 'modoRegistro' aquÃ­, porque ya vienen de app.js

        window.onload = async function () {
            // ... (el resto de tu cÃ³digo se queda igual)
            const params = new URLSearchParams(window.location.search);
            const id = params.get('id');
            if (!id) { window.location.href = "index.html"; return; }

            const { data, error } = await clienteSupabase.from('productos').select('*').eq('id', id).single();
            if (error || !data) { document.getElementById('contenido-principal').innerHTML = "<h2>Producto no encontrado</h2>"; return; }

            productoActual = data;
            renderizarProducto();
            renderizarEspecificaciones();
            cargarResenas(id);
            cargarRecomendados(data.categoria_id, id);
            verificarSesion();

            document.getElementById('seccion-resenas').style.display = 'block';
            document.getElementById('seccion-recomendados').style.display = 'block';

            if (window.location.hash === '#abrir-carrito') { setTimeout(() => abrirCarrito(), 500); }
            if (window.location.hash === '#abrir-login') { setTimeout(() => abrirLogin(), 500); }
        };

        function renderizarProducto() {
            // 1. Obtenemos el contenedor y aseguramos la clase para el CSS
            const cont = document.getElementById('detalle-producto');
            cont.className = 'container-producto';

            // =========================================================
            // LÃ“GICA DE STOCK (SOLUCIÃ“N AL BUG)
            // =========================================================
            // El operador '??' respeta el 0. Si viene null/undefined, pone 0.
            const stockReal = productoActual.stock_actual ?? 0;
            const hayStock = stockReal > 0;

            // Preparamos la etiqueta visual del stock
            let htmlStockTag = '';

            if (hayStock) {
                // STOCK DISPONIBLE (Verde o normal)
                htmlStockTag = `
            <div class="stock-tag">
                <span class="material-icons" style="font-size:14px; vertical-align:text-bottom;">inventory_2</span> 
                DISPONIBLES: ${stockReal}
            </div>`;
            } else {
                // AGOTADO (Rojo y llamativo)
                htmlStockTag = `
            <div class="stock-tag" style="color: #dc3545; background-color: #fff5f5; border: 1px solid #dc3545; display: inline-block; padding: 5px 10px; border-radius: 5px;">
                ðŸš« AGOTADO
            </div>`;
            }

            // =========================================================
            // LÃ“GICA DEL BOTÃ“N (HABILITADO VS DESHABILITADO)
            // =========================================================
            let htmlBoton = '';

            if (hayStock) {
                // BotÃ³n Azul Normal
                htmlBoton = `
            <button class="btn-agregar-grande" onclick="agregarEsteProducto()">
                <span class="material-icons">shopping_cart</span> Agregar al Carrito
            </button>`;
            } else {
                // BotÃ³n Gris Deshabilitado (No deja hacer clic)
                htmlBoton = `
            <button class="btn-agregar-grande" disabled style="background-color: #ccc; cursor: not-allowed; opacity: 0.7;">
                <span class="material-icons">remove_shopping_cart</span> Sin Stock
            </button>`;
            }

            // =========================================================
            // LÃ“GICA DE PRECIO (CON O SIN DESCUENTO)
            // =========================================================
            let htmlPrecio = `<div class="precio-grande">$${productoActual.precio.toFixed(2)}</div>`;

            if (productoActual.descuento > 0) {
                const precioConDescuento = productoActual.precio * (1 - productoActual.descuento / 100);
                htmlPrecio = `
            <div style="display: flex; align-items: center; gap: 15px; margin: 15px 0;">
                <span style="text-decoration: line-through; color: #999; font-size: 1.3em;">
                    $${productoActual.precio.toFixed(2)}
                </span>
                <span class="precio-grande" style="color: #dc3545; margin: 0;">
                    $${precioConDescuento.toFixed(2)}
                </span>
                <span style="background: #dc3545; color: white; padding: 4px 10px; border-radius: 20px; font-weight: bold; font-size: 0.8em;">
                    -${productoActual.descuento}%
                </span>
            </div>`;
            }

            // =========================================================
            // RENDERIZADO FINAL DEL HTML
            // =========================================================
            cont.innerHTML = `
        <div class="img-wrapper" onmouseenter="activarZoom()" onmouseleave="desactivarZoom()">
            <img id="myimage" src="${productoActual.imagen_url}" class="img-producto" onclick="abrirLightbox('${productoActual.imagen_url}')" onerror="this.src='https://via.placeholder.com/400'">
            
            <div id="lens" class="img-zoom-lens"></div>
            <div id="result" class="img-zoom-result"></div>
            
            <div style="position:absolute; bottom:15px; right:15px; background:rgba(255,255,255,0.9); color:#333; padding:5px 12px; border-radius:20px; font-size:0.8em; font-weight:bold; pointer-events:none; box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                <span class="material-icons" style="font-size:16px; vertical-align:middle;">zoom_in</span> Zoom
            </div>
        </div>
        
        <div class="info-producto">
            <div style="font-size:0.9em; color:#888; margin-bottom:10px;">
                <a href="index.html" style="color:#0056b3; text-decoration:none;">Inicio</a> / 
                <span>${productoActual.nombre}</span>
            </div>
            
            <h1>${productoActual.nombre}</h1>
            
            ${htmlStockTag}
            
            ${htmlPrecio}

            <div class="descripcion-box">
                <h3 style="margin-top:0; color:#333;">Detalles del Producto</h3>
                <p>${productoActual.descripcion || "Sin descripciÃ³n detallada."}</p>
            </div>
            
            ${htmlBoton}
            
            <div style="margin-top: 20px; font-size: 0.85em; color: #777; display: flex; gap: 15px; flex-wrap: wrap;">
                <span style="display:flex; align-items:center; gap:5px;"><span class="material-icons" style="font-size:16px;">verified</span> GarantÃ­a directa</span>
                <span style="display:flex; align-items:center; gap:5px;"><span class="material-icons" style="font-size:16px;">local_shipping</span> EnvÃ­o seguro</span>
            </div>
        </div>
    `;

            // Actualizamos el tÃ­tulo de la pestaÃ±a del navegador
            document.title = productoActual.nombre + " - RouterShop TX";
        }

        // --- ZOOM AMAZON ---
        function activarZoom() {
            if (window.innerWidth <= 768) return;
            const img = document.getElementById("myimage");
            const lens = document.getElementById("lens");
            const result = document.getElementById("result");
            if (!img || !lens || !result) return;

            lens.style.display = "block";
            result.style.display = "block";
            const cx = result.offsetWidth / lens.offsetWidth;
            const cy = result.offsetHeight / lens.offsetHeight;
            result.style.backgroundImage = "url('" + img.src + "')";
            result.style.backgroundSize = (img.width * cx) + "px " + (img.height * cy) + "px";

            lens.addEventListener("mousemove", moveLens);
            img.addEventListener("mousemove", moveLens);
            lens.addEventListener("touchmove", moveLens);
            img.addEventListener("touchmove", moveLens);

            function moveLens(e) {
                e.preventDefault();
                const pos = getCursorPos(e);
                let x = pos.x - (lens.offsetWidth / 2);
                let y = pos.y - (lens.offsetHeight / 2);
                if (x > img.width - lens.offsetWidth) { x = img.width - lens.offsetWidth; }
                if (x < 0) { x = 0; }
                if (y > img.height - lens.offsetHeight) { y = img.height - lens.offsetHeight; }
                if (y < 0) { y = 0; }
                lens.style.left = x + "px";
                lens.style.top = y + "px";
                result.style.backgroundPosition = "-" + (x * cx) + "px -" + (y * cy) + "px";
            }
            function getCursorPos(e) {
                let a, x = 0, y = 0;
                e = e || window.event;
                a = img.getBoundingClientRect();
                x = e.pageX - a.left;
                y = e.pageY - a.top;
                x = x - window.pageXOffset;
                y = y - window.pageYOffset;
                return { x: x, y: y };
            }
        }
        function desactivarZoom() { document.getElementById("lens").style.display = "none"; document.getElementById("result").style.display = "none"; }

        // --- EXTRAS ---
        function abrirLightbox(src) { document.getElementById('modal-lightbox').style.display = "block"; document.getElementById('img-lightbox-full').src = src; }
        function cerrarLightbox() { document.getElementById('modal-lightbox').style.display = "none"; }

        function agregarEsteProducto() {
            if (!productoActual) return;

            // 1. CALCULAR PRECIO REAL (Esto sÃ­ lo dejamos aquÃ­)
            let precioFinal = productoActual.precio;
            if (productoActual.descuento > 0) {
                precioFinal = productoActual.precio * (1 - productoActual.descuento / 100);
            }

            // 2. Â¡CORRECCIÃ“N! 
            // En lugar de hacer "carrito.push" manualmente, llamamos a la funciÃ³n 
            // SEGURA de app.js que revisa el stock antes de agregar.

            agregarAlCarrito(
                productoActual.id,
                productoActual.nombre,
                precioFinal,
                productoActual.imagen_url,
                1 // Cantidad: 1 (O si tuvieras un input de cantidad, pon su valor aquÃ­)
            );
        }

        async function verificarSesion() { const { data: { session } } = await clienteSupabase.auth.getSession(); if (session) { document.getElementById('box-form-resena').style.display = 'block'; document.getElementById('msg-login-resena').style.display = 'none'; } else { document.getElementById('box-form-resena').style.display = 'none'; document.getElementById('msg-login-resena').style.display = 'block'; } }

        async function cargarResenas(id) {
            const { data } = await clienteSupabase.from('resenas').select('*').eq('producto_id', id);
            const l = document.getElementById('lista-resenas'); l.innerHTML = '';
            if (data && data.length > 0) {
                let suma = 0;
                data.forEach(r => {
                    suma += r.estrellas;
                    l.innerHTML += `
                    <div class="comentario-item">
                        <div class="comentario-user">
                            ${r.email_usuario.split('@')[0]}
                            <span class="estrellas-mini">${'â˜…'.repeat(r.estrellas)}</span>
                        </div>
                        <div class="comentario-texto">${r.comentario}</div>
                    </div>`;
                });
                document.getElementById('txt-promedio').innerText = (suma / data.length).toFixed(1);
                document.getElementById('txt-total-votos').innerText = `(${data.length} opiniones)`;
            } else { l.innerHTML = '<p style="color:#777; font-style:italic;">AÃºn no hay opiniones.</p>'; }
        }

        async function enviarResena() { const { data: { session } } = await clienteSupabase.auth.getSession(); if (!session) return mostrarNotificacion("Inicia sesiÃ³n", "error"); const s = document.getElementById('sel-estrellas').value; const c = document.getElementById('txt-comentario').value; await clienteSupabase.from('resenas').insert([{ producto_id: productoActual.id, usuario_id: session.user.id, email_usuario: session.user.email, estrellas: parseInt(s), comentario: c }]); mostrarNotificacion("Enviada", "success"); setTimeout(() => window.location.reload(), 1000); }
        async function cargarRecomendados(c, i) { const { data } = await clienteSupabase.from('productos').select('*').eq('categoria_id', c).neq('id', i).limit(4); const g = document.getElementById('grid-recomendados'); if (data) data.forEach(p => g.innerHTML += `<a href="producto.html?id=${p.id}" class="card-rec"><img src="${p.imagen_url}"><p style="font-size:0.9em; margin-top:5px;">${p.nombre}</p></a>`); }

        function renderizarEspecificaciones() {
            const seccionSpecs = document.getElementById('seccion-ficha-tecnica');
            const cuerpoTabla = document.getElementById('cuerpo-tabla-specs');

            // 1. Verificamos si hay datos en la columna 'especificaciones'
            if (!productoActual.especificaciones || Object.keys(productoActual.especificaciones).length === 0) {
                seccionSpecs.style.display = 'none'; // Si estÃ¡ vacÃ­o, ocultamos la secciÃ³n
                return;
            }

            // 2. Si hay datos, mostramos la secciÃ³n
            seccionSpecs.style.display = 'block';
            cuerpoTabla.innerHTML = ''; // Limpiamos tabla anterior

            // 3. Recorremos el objeto JSON (Clave -> Valor)
            for (const [clave, valor] of Object.entries(productoActual.especificaciones)) {
                cuerpoTabla.innerHTML += `
            <tr>
                <td>${clave}</td>
                <td>${valor}</td>
            </tr>
        `;
            }
        }
    </script>
</body>

</html>