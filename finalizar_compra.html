<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finalizar Compra - RouterShop TX</title>
    <link rel="icon" type="image/png"
        href="https://qalbtsegnuwbnjnndvag.supabase.co/storage/v1/object/public/fotos-productos/logo.png">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

    <script>
        (function () {
            emailjs.init("S6x887RD35YnO33Eg");
        })();
    </script>

    <link rel="stylesheet" href="css/estilos.css">
    <link rel="stylesheet" href="css/finalizar_compra.css">

</head>

<body>
    <div id="loader-wrapper" class="loader-container">
        <div class="loader-brand">
            <img src="https://qalbtsegnuwbnjnndvag.supabase.co/storage/v1/object/public/fotos-productos/logo.png"
                style="height: 60px;">

            <div style="text-align: left;">
                <div style="color: #003366; font-weight: 800; font-size: 24px; font-family: 'Poppins', sans-serif;">
                    RouterShop</div>
                <div
                    style="color: #ffc107; font-weight: 800; font-size: 24px; font-family: 'Poppins', sans-serif; line-height: 0.8;">
                    TX</div>
            </div>
        </div>
        <div class="spinner"></div>
    </div>

    <div id="app-navbar"></div>

    <div class="layout-offset" style="height: 110px;"></div>

    <div id="notificacion-toast" class="notificacion-container">
        <span id="notif-icono" class="material-icons">info</span><span id="notif-mensaje">Mensaje</span>
    </div>


    <div class="contenedor-checkout">
        <div class="col-izq">
            <div class="seccion">
                <h2>1. Datos de Envío <button class="btn-azul" onclick="toggleFormDireccion()">Cambiar</button></h2>
                <div id="card-direccion-guardada" class="direccion-card">
                    <strong>Recibe:</strong> <span id="dir-nombre">...</span><br>
                    <strong>Dirección:</strong> <span id="dir-calle">...</span><br>
                    <span id="dir-detalles" style="color:#666; font-size:0.9em;">...</span>
                </div>
                <p id="msg-sin-direccion" style="display:none; color:#d63343; font-weight:bold;">⚠️ Agrega dirección.
                </p>
                <div id="form-direccion" class="form-direccion">
                    <input type="text" id="in-nombre" class="full-width" placeholder="Nombre completo">
                    <input type="text" id="in-calle" class="full-width" placeholder="Calle">
                    <input type="text" id="in-num-ext" placeholder="Número Exterior">
                    <input type="text" id="in-num-int" placeholder="Número Interior (Opcional)">
                    <input type="text" id="in-colonia" placeholder="Colonia">
                    <input type="text" id="in-cp" placeholder="CP">
                    <input type="text" id="in-ciudad" placeholder="Ciudad">
                    <input type="text" id="in-estado" placeholder="Estado">
                    <input type="text" id="in-ref" class="full-width" placeholder="Referencias">
                    <button class="btn-azul full-width" onclick="guardarDireccion()"
                        style="margin-top:10px;">Guardar</button>
                </div>
            </div>

            <div class="seccion">
                <h2>2. Paquetería</h2>
                <label class="opcion-radio">
                    <input type="radio" name="envio" value="DHL" data-costo="250" onchange="recalcular()" checked>
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ac/DHL_Logo.svg/320px-DHL_Logo.svg.png"
                        alt="DHL" class="logo-opcion">
                    <div class="opcion-texto"><strong>DHL Express</strong><br><small>Día siguiente</small></div>
                    <span class="precio-extra">$250</span>
                </label>
                <label class="opcion-radio">
                    <input type="radio" name="envio" value="FedEx" data-costo="180" onchange="recalcular()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/9d/FedEx_Express.svg/320px-FedEx_Express.svg.png"
                        alt="FedEx" class="logo-opcion">
                    <div class="opcion-texto"><strong>FedEx Estándar</strong><br><small>3-5 días</small></div>
                    <span class="precio-extra">$180</span>
                </label>
                <label class="opcion-radio">
                    <input type="radio" name="envio" value="Estafeta" data-costo="150" onchange="recalcular()">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/7f/Logo_de_Estafeta.svg" alt="Estafeta"
                        class="logo-opcion">
                    <div class="opcion-texto"><strong>Estafeta Económico</strong><br><small>5-7 días</small></div>
                    <span class="precio-extra">$150</span>
                </label>
            </div>

            <div class="seccion">
                <h2>3. Método de Pago</h2>

                <label class="opcion-radio">
                    <input type="radio" name="pago" value="tarjeta" onclick="toggleInfoPago()" id="radio-tarjeta">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="material-icons icon-animado">credit_card</span>
                            <div class="opcion-texto"><strong>Tarjeta de Crédito / Débito</strong></div>
                        </div>
                        <div style="display: flex; gap: 5px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/4/41/Visa_Logo.png" alt="Visa"
                                style="height: 14px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg"
                                alt="Mastercard" style="height: 18px;">
                        </div>
                    </div>
                </label>

                <div id="contenedor-formulario-tarjeta" style="display: none;">
                    <div id="form-tarjeta-inputs" class="form-grid-tarjeta">
                        <div class="campo-full">
                            <input type="text" id="card-number" class="input-estilo-envio"
                                placeholder="Número de tarjeta" maxlength="19" onkeyup="formatCardNumber(this)">
                        </div>
                        <div class="campo-full">
                            <input type="text" id="card-name" class="input-estilo-envio"
                                placeholder="NOMBRE DEL TITULAR" style="text-transform: uppercase;">
                        </div>
                        <div>
                            <input type="text" id="card-expiry" class="input-estilo-envio" placeholder="MM/AA"
                                maxlength="5" onkeyup="formatExpiry(this)">
                        </div>
                        <div style="position: relative;">
                            <input type="password" id="card-cvc" class="input-estilo-envio" placeholder="CVC"
                                maxlength="4">
                            <span class="material-icons"
                                style="position: absolute; right: 10px; top: 12px; color: #ccc; font-size: 18px; cursor: help;"
                                title="3 dígitos al reverso">help</span>
                        </div>
                        <div class="campo-full">
                            <button class="btn-guardar-azul" onclick="guardarTarjetaLocal()">Guardar Tarjeta</button>
                        </div>
                        <div class="campo-full"
                            style="text-align: center; font-size: 12px; color: #888; margin-top: 5px;">
                            <span class="material-icons" style="font-size: 12px; vertical-align: middle;">lock</span>
                            Tus datos se guardan de forma segura temporalmente.
                        </div>
                    </div>

                    <div id="card-resumen" class="resumen-tarjeta-container" style="display: none;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span class="material-icons" style="color: #28a745; font-size: 28px;">check_circle</span>
                            <div>
                                <div style="font-weight: bold; color: #333;">Tarjeta Guardada</div>
                                <div style="font-size: 0.9em; color: #666;">Terminada en <span
                                        id="lbl-last4">****</span></div>
                            </div>
                        </div>
                        <button class="btn-editar-tarjeta" onclick="editarTarjeta()">Cambiar</button>
                    </div>
                </div>

                <label class="opcion-radio" style="margin-top: 10px;">
                    <input type="radio" name="pago" value="paypal" onclick="toggleInfoPago()">
                    <div style="display: flex; align-items: center; justify-content: space-between; width: 100%;">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <img src="https://upload.wikimedia.org/wikipedia/commons/b/b5/PayPal.svg" alt="PayPal"
                                class="logo-pago" style="height: 24px;">

                            <div class="opcion-texto">
                                <strong style="color: #003087;">PayPal</strong><br>
                                <small>Pago rápido y seguro</small>
                            </div>
                        </div>
                    </div>
                </label>

                <label class="opcion-radio" style="margin-top: 10px;">
                    <input type="radio" name="pago" value="transferencia" onclick="toggleInfoPago()">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="material-icons icon-opcion-big logo-opcion">account_balance</span>
                        <div class="opcion-texto"><strong>Transferencia SPEI</strong><br><small>BBVA</small></div>
                    </div>
                </label>

                <div id="info-transferencia"
                    style="display: none; padding: 15px; background: #f9f9f9; border: 1px solid #eee; margin-top: 5px; border-radius: 6px;">
                    <strong>Datos para transferir:</strong><br>
                    Banco: BBVA - CLABE: 012 345 678901234567<br>
                    <small>Envía comprobante a contacto@routershop.com o WhatsApp</small>
                </div>

            </div>
        </div>

        <div class="col-der">
            <div class="resumen-card">
                <h2>Resumen</h2>
                <div id="lista-resumen" style="max-height: 250px; overflow-y: auto;"></div>

                <div class="cupon-container">
                    <input type="text" id="input-cupon" class="input-cupon" placeholder="CÓDIGO DE CUPÓN">
                    <button class="btn-cupon" onclick="aplicarCupon()">USAR</button>
                </div>

                <div class="totales">
                    <div class="fila-total"><span>Subtotal:</span><span id="txt-subtotal">$0.00</span></div>
                    <div class="fila-total"><span>Envío:</span><span id="txt-envio">$0.00</span></div>
                    <div class="fila-total" id="fila-descuento" style="display:none;"><span
                            class="descuento-texto">Descuento:</span><span id="txt-descuento"
                            class="descuento-texto">-$0.00</span></div>
                    <div class="fila-total final"><span>Total:</span><span id="txt-total">$0.00</span></div>
                </div>

                <button id="btn-finalizar" class="btn-pagar" onclick="confirmarCompra()">
                    <span class="material-icons">lock</span> PAGAR AHORA
                </button>
                <p
                    style="font-size: 0.85em; color: #777; margin-top: 15px; display: flex;justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;">
                    <span class="material-icons" style="font-size: 1.2em; color: #28a745;">lock</span>
                    <span>*Precios incluyen impuestos.</span>
                    <span style="color:#ccc;">|</span>
                    <img src="https://cdn-icons-png.flaticon.com/512/2438/2438078.png" alt="Pago Seguro SSL"
                        style="height: 22px; width: auto; opacity: 0.8;">
                    <span style="font-weight: 600; font-size: 0.9em;">Pagos 100% Seguros</span>
                </p>
            </div>
        </div>
    </div>

    <div id="app-footer"></div>
    <script src="js/loader.js"></script>
    <script src="js/app.js"></script>

    <script>
        let usuarioActual = null;
        let direccionID = null;
        let totalFinal = 0;
        let descuentoPorcentaje = 0;

        window.onload = async function () {
            const { data: { session } } = await clienteSupabase.auth.getSession();
            if (!session) { window.location.href = "index.html"; return; }
            usuarioActual = session.user;
            if (carrito.length === 0) { window.location.href = "index.html"; return; }
            cargarDireccion(); renderItems(); recalcular();
        };

        // --- CUPÓN DE DESCUENTO ---
        async function aplicarCupon() {
            const codigo = document.getElementById('input-cupon').value.toUpperCase().trim();
            if (!codigo) return mostrarNotificacion("Escribe un código", "error");
            mostrarNotificacion("Validando...", "info");

            const { data } = await clienteSupabase.from('cupones').select('*').eq('codigo', codigo).eq('activo', true).single();
            if (!data) {
                mostrarNotificacion("Cupón no válido", "error");
                descuentoPorcentaje = 0;
            } else {
                descuentoPorcentaje = data.porcentaje_descuento;
                mostrarNotificacion(`¡Ahorras ${descuentoPorcentaje}%!`, "success");
                document.getElementById('input-cupon').disabled = true;
            }
            recalcular();
        }

        function recalcular() {
            // 1. Calcular Subtotal de productos
            const subtotalProductos = carrito.reduce((sum, i) => sum + (i.precio * i.cantidad), 0);

            // 2. ¿Aplica Envío Gratis? (Mayor a $2000)
            const esEnvioGratis = subtotalProductos > 2000;

            // 3. ACTUALIZAR VISUALMENTE LAS TARJETAS DE PAQUETERÍA
            // Buscamos todas las opciones de radio button de envío
            const opcionesEnvio = document.querySelectorAll('input[name="envio"]');

            opcionesEnvio.forEach(opcion => {
                // Buscamos la etiqueta del precio que está al lado (el span .precio-extra)
                const labelPadre = opcion.closest('label');
                const spanPrecio = labelPadre.querySelector('.precio-extra');
                const costoOriginal = opcion.getAttribute('data-costo');

                if (esEnvioGratis) {
                    // Si es gratis, cambiamos el texto a verde y ponemos "Gratis"
                    spanPrecio.innerText = "¡Gratis!";
                    spanPrecio.style.color = "#28a745"; // Verde
                    spanPrecio.style.fontWeight = "bold";
                    // Opcional: Tachamos un poco el precio original si quisieras, 
                    // pero "¡Gratis!" se ve mejor limpio.
                } else {
                    // Si NO es gratis, restauramos el precio original
                    spanPrecio.innerText = `$${costoOriginal}`;
                    spanPrecio.style.color = "#666"; // Color gris original
                    spanPrecio.style.fontWeight = "normal";
                }
            });

            // 4. Determinar costo de envío para la suma final
            let costoEnvio = 0;

            if (esEnvioGratis) {
                costoEnvio = 0;
            } else {
                // Si no es gratis, tomamos el costo del radio button seleccionado
                costoEnvio = parseFloat(document.querySelector('input[name="envio"]:checked').getAttribute('data-costo'));
            }

            // 5. Calcular Descuentos
            const montoDescuento = subtotalProductos * (descuentoPorcentaje / 100);

            // 6. TOTAL FINAL
            totalFinal = subtotalProductos + costoEnvio - montoDescuento;

            // --- ACTUALIZAR RESUMEN (Derecha) ---
            document.getElementById('txt-subtotal').innerText = `$${subtotalProductos.toFixed(2)}`;

            // Actualizar texto de envío en el resumen
            const txtEnvioResumen = document.getElementById('txt-envio');
            if (esEnvioGratis) {
                txtEnvioResumen.innerText = "Gratis";
                txtEnvioResumen.style.color = "#28a745";
                txtEnvioResumen.style.fontWeight = "bold";
            } else {
                txtEnvioResumen.innerText = `$${costoEnvio.toFixed(2)}`;
                txtEnvioResumen.style.color = "#333";
                txtEnvioResumen.style.fontWeight = "normal";
            }

            // Mostrar fila de descuento si existe
            if (montoDescuento > 0) {
                document.getElementById('fila-descuento').style.display = 'flex';
                document.getElementById('txt-descuento').innerText = `-$${montoDescuento.toFixed(2)}`;
            } else {
                document.getElementById('fila-descuento').style.display = 'none';
            }

            document.getElementById('txt-total').innerText = `$${totalFinal.toFixed(2)}`;
        }

        function renderItems() {
            const lista = document.getElementById('lista-resumen');
            lista.innerHTML = '';
            carrito.forEach(item => {
                const img = item.imagen || 'https://via.placeholder.com/50';
                lista.innerHTML += `<div class="item-resumen"><img src="${img}"><div class="item-info"><strong>${item.nombre}</strong><br><small>Cant: ${item.cantidad}</small></div><strong>$${(item.precio * item.cantidad).toFixed(2)}</strong></div>`;
            });
        }

        async function cargarDireccion() {
            const { data } = await clienteSupabase.from('direcciones').select('*').eq('usuario_id', usuarioActual.id).order('id', { ascending: false }).limit(1);
            if (data && data.length > 0) {
                direccionID = data[0].id;
                document.getElementById('card-direccion-guardada').style.display = 'block';
                document.getElementById('form-direccion').style.display = 'none';
                document.getElementById('dir-nombre').innerText = data[0].nombre_receptor;
                const numExt = data[0].numero_exterior || '';
                const numInt = data[0].numero_interior ? `Int. ${data[0].numero_interior}` : '';
                document.getElementById('dir-calle').innerText = `${data[0].calle} #${numExt} ${numInt}, ${data[0].colonia}`;
                document.getElementById('dir-detalles').innerText = `${data[0].ciudad}, CP: ${data[0].codigo_postal}`;
                document.getElementById('msg-sin-direccion').style.display = 'none';
            } else {
                document.getElementById('msg-sin-direccion').style.display = 'block';
                document.getElementById('form-direccion').style.display = 'grid';
            }
        }

        function toggleFormDireccion() {
            const form = document.getElementById('form-direccion');
            const card = document.getElementById('card-direccion-guardada');
            if (form.style.display === 'none') { form.style.display = 'grid'; card.style.display = 'none'; }
            else if (direccionID) { form.style.display = 'none'; card.style.display = 'block'; }
        }

        async function guardarDireccion() {
            const nombre = document.getElementById('in-nombre').value;
            const calle = document.getElementById('in-calle').value;
            const cp = document.getElementById('in-cp').value;
            const numExt = document.getElementById('in-num-ext').value;
            const numInt = document.getElementById('in-num-int').value;

            if (!calle || !nombre || !numExt) return mostrarNotificacion("Faltan datos (Nombre, Calle, Num. Exterior)", "error");

            const { error } = await clienteSupabase.from('direcciones').insert([{
                usuario_id: usuarioActual.id,
                nombre_receptor: nombre,
                calle,
                numero_exterior: numExt,
                numero_interior: numInt,
                colonia: document.getElementById('in-colonia').value,
                codigo_postal: cp,
                ciudad: document.getElementById('in-ciudad').value,
                estado_provincia: document.getElementById('in-estado').value,
                referencias: document.getElementById('in-ref').value
            }]);

            if (!error) { mostrarNotificacion("Dirección guardada", "success"); cargarDireccion(); }
            else mostrarNotificacion("Error: " + error.message, "error");
        }

        // --- LÓGICA TARJETA Y PAGO ---
        let tarjetaEnMemoria = null;

        function toggleInfoPago() {
            const opcionRadio = document.querySelector('input[name="pago"]:checked');
            if (!opcionRadio) return;

            const opcion = opcionRadio.value;
            const contenedorTarjeta = document.getElementById('contenedor-formulario-tarjeta');
            const infoTransferencia = document.getElementById('info-transferencia');

            // 1. Si es Tarjeta
            if (opcion === 'tarjeta') {
                contenedorTarjeta.style.display = 'block';
                infoTransferencia.style.display = 'none';
            }
            // 2. Si es Transferencia
            else if (opcion === 'transferencia') {
                contenedorTarjeta.style.display = 'none';
                infoTransferencia.style.display = 'block';
            }
            // 3. Si es PayPal (u otros futuros)
            else {
                contenedorTarjeta.style.display = 'none';
                infoTransferencia.style.display = 'none';
            }
        }

        function formatCardNumber(input) {
            let value = input.value.replace(/\D/g, '');
            let formattedValue = '';
            for (let i = 0; i < value.length; i++) {
                if (i > 0 && i % 4 === 0) formattedValue += ' ';
                formattedValue += value[i];
            }
            input.value = formattedValue;
        }

        function formatExpiry(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length >= 2) {
                input.value = value.substring(0, 2) + '/' + value.substring(2, 4);
            } else {
                input.value = value;
            }
        }

        function guardarTarjetaLocal() {
            const num = document.getElementById('card-number').value;
            const nombre = document.getElementById('card-name').value;
            const exp = document.getElementById('card-expiry').value;
            const cvc = document.getElementById('card-cvc').value;

            if (num.length < 16 || !nombre || !exp || !cvc) {
                mostrarNotificacion("Completa todos los campos", "error");
                return;
            }

            tarjetaEnMemoria = { numero: num, nombre: nombre, exp: exp, cvc: cvc };
            document.getElementById('form-tarjeta-inputs').style.display = 'none';
            document.getElementById('card-resumen').style.display = 'flex';
            document.getElementById('lbl-last4').innerText = num.slice(-4);
            mostrarNotificacion("Tarjeta guardada temporalmente", "success");
        }

        function editarTarjeta() {
            tarjetaEnMemoria = null;
            document.getElementById('form-tarjeta-inputs').style.display = 'grid';
            document.getElementById('card-resumen').style.display = 'none';
        }

        async function confirmarCompra() {
            if (!direccionID) return mostrarNotificacion("Selecciona dirección", "error");

            const pagoInput = document.querySelector('input[name="pago"]:checked');
            if (!pagoInput) return mostrarNotificacion("Selecciona un método de pago", "error");

            const pago = pagoInput.value;

            // VALIDACIÓN: Si eligió tarjeta manual, debe haber guardado los datos
            if (pago === 'tarjeta' && !tarjetaEnMemoria) {
                return mostrarNotificacion("Guarda los datos de tu tarjeta primero", "error");
            }

            const btn = document.getElementById('btn-finalizar');
            const envio = document.querySelector('input[name="envio"]:checked').value;

            // --- LÓGICA DE ESTADO SEGÚN MÉTODO DE PAGO ---
            let estadoInicial = 'pendiente_pago'; // Por defecto para transferencia

            if (pago === 'tarjeta' || pago === 'paypal') {
                estadoInicial = 'pagado';
            }

            btn.innerText = "Procesando...";
            btn.disabled = true;

            let idVenta = null;

            try {
                // OBTENER DATOS DEL DOM
                const elemNombre = document.getElementById('dir-nombre');
                const elemCalle = document.getElementById('dir-calle');
                const elemDetalles = document.getElementById('dir-detalles');
                const textoNombre = elemNombre ? elemNombre.innerText : "Cliente";
                const textoDireccion = (elemCalle && elemDetalles) ? `${elemCalle.innerText} ${elemDetalles.innerText}` : "Dirección no especificada";

                // CREAR VENTA EN SUPABASE
                const { data: venta, error: errorVenta } = await clienteSupabase.from('ventas').insert([{
                    usuario_id: usuarioActual.id,
                    direccion_envio_id: direccionID,
                    total: totalFinal,
                    estado: estadoInicial, // <--- Aquí usamos la lógica del estado
                    fecha_compra: new Date(),
                    paqueteria: envio,
                    numero_guia_envio: 'PENDIENTE',
                    direccion_envio: `${textoNombre} - ${textoDireccion}`,
                    detalles_contacto: `Usuario: ${usuarioActual.email}`,
                    productos_json: carrito
                }]).select();

                if (errorVenta) throw errorVenta;
                idVenta = venta[0].id;

                // GUARDAR DETALLES
                const detalles = carrito.map(i => ({
                    venta_id: idVenta,
                    producto_id: i.id,
                    cantidad: i.cantidad,
                    precio_unitario: i.precio
                }));

                const { error: errorDetalle } = await clienteSupabase.from('detalle_ventas').insert(detalles);
                if (errorDetalle) throw errorDetalle;

                // ENVÍO DE CORREO
                try {
                    const { data: { session } } = await clienteSupabase.auth.getSession();
                    const emailDestino = session ? session.user.email : null;
                    if (emailDestino) {
                        const parametrosEmail = {
                            to_name: textoNombre,
                            to_email: emailDestino,
                            order_id: idVenta,
                            total: totalFinal.toFixed(2),
                            address: textoDireccion,
                            products: carrito.map(item => `- ${item.cantidad}x ${item.nombre}`).join('\n')
                        };
                        emailjs.send("service_i1yzl9c", "template_o6nl56z", parametrosEmail);
                    }
                } catch (errorMail) { console.error(errorMail); }

                // FINALIZACIÓN
                mostrarNotificacion("¡Compra realizada con éxito!", "success");
                localStorage.removeItem('carrito');
                setTimeout(() => {
                    window.location.href = `confirmacion.html?id=${idVenta}`;
                }, 1500);

            } catch (error) {
                console.error("Error crítico en la compra:", error);
                mostrarNotificacion("Hubo un problema: " + (error.message || "Error de BD"), "error");
                btn.disabled = false;
                btn.innerText = "PAGAR AHORA";
            }
        }
    </script>
</body>

</html>